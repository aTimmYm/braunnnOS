local ret = {}

function ret.readMP4Metadata(data)
    local function readAtom(pos)
        if pos > #data - 8 then
            return 0, "", pos
        end
        local b = function(p) return string_byte(data, p) or 0 end
        local size = b(pos) * 16777216 + b(pos+1) * 65536 + b(pos+2) * 256 + b(pos+3)
        local atype = string_sub(data, pos+4, pos+7)

        -- extended size
        if size == 1 and pos + 16 <= #data then
            local ext = 0
            for i = 0, 7 do ext = ext * 256 + b(pos + 8 + i) end
            return ext, atype, pos + 16
        end
        return size, atype, pos + 8
    end

    local function safeReadUInt32(p)
        local b = function(q) return string_byte(data, q) or 0 end
        return b(p) * 16777216 + b(p+1) * 65536 + b(p+2) * 256 + b(p+3)
    end

    local result = { title = "", artist = "", album = "" }

    local function processContainer(startPos, endPos)
        local pos = startPos
        while pos < endPos do
            local size, atype, payloadStart = readAtom(pos)
            if size == 0 or size > #data then break end

            if atype == "ilst" then
                local ilstEnd = pos + size
                local itemPos = payloadStart
                while itemPos < ilstEnd do
                    local itemSize, itemType, itemPayload = readAtom(itemPos)
                    if itemSize == 0 or itemSize > #data then break end

                    local dataAtomSize = safeReadUInt32(itemPayload)
                    local dataAtomType = string_sub(data, itemPayload+4, itemPayload+7)

                    if dataAtomType == "data" then
                        local valueStart = itemPayload + 8 + 8  -- -> itemPayload + 16
                        local valueEnd = itemPayload + dataAtomSize - 1
                        if valueStart <= valueEnd and valueEnd <= #data then
                            local raw = string_sub(data, valueStart, valueEnd)

                            local b1, b2 = string_byte(raw,1) or 0, string_byte(raw,2) or 0
                            local encoding = 3 -- utf-8 за замовчуванням
                            if b1 == 0xFE and b2 == 0xFF or (b1 == 0xFF and b2 == 0xFE) then
                                encoding = 1 -- UTF-16 (BOM)
                            end

                            local value = decode_and_translit(encoding, raw)

                            local suffix = (itemType:sub(-3) or ""):lower()
                            if suffix == "nam" then result.title = value
                            elseif suffix == "art" then
                                -- '©ART' or 'aART' both end with 'ART'
                                result.artist = value
                            elseif suffix == "alb" then result.album = value end
                        else
                            term.setTextColor(colors.red)
                            print("Data atom bounds invalid:", valueStart, valueEnd, "#data=", #data)
                            term.setTextColor(termTxtcol)
                        end
                    end

                    itemPos = itemPos + itemSize
                end

                break
            elseif atype == "moov" or atype == "udta" or atype == "meta" then
                local skip = (atype == "meta") and 4 or 0 -- meta має 4 байти після заголовка (version/flags)
                processContainer(payloadStart + skip, pos + size)
            end

            pos = pos + size
        end
    end

    processContainer(1, #data)
    return result
end

return ret